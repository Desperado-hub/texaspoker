# 在线多人德州扑克系统架构概述

本架构面向非真钱娱乐版德州扑克，支持 6 人桌与 9 人桌，强调可扩展、可维护的分层设计。系统分为客户端、网关/接入层、业务服务层、基础设施与存储层。

## 分层说明
- **客户端层**：提供大厅、房间/牌桌 UI、玩家操作与动画。通过 HTTP 访问基础数据，WebSocket/RTC 进行实时指令与状态同步，并具备断线重连与状态恢复能力。
- **网关与接入层**：API Gateway 负责鉴权、限流与接口聚合；Realtime Gateway 负责长连接管理、心跳、消息编解码与路由，将玩家操作转发到对应的桌实例。
- **业务服务层**：包含大厅匹配、牌桌管理、游戏逻辑裁决、虚拟经济、数据战绩、聊天、通知、防作弊等核心服务。每张桌作为独立状态机，支持按桌号/会话的固定路由，便于水平扩展。
- **基础设施与存储层**：消息队列解耦异步事件；缓存用于会话与桌状态快照；关系型数据库与对象存储用于事件、结算和回放；监控与链路追踪确保可观测性。

## 模块交互关系
1. **客户端 → API Gateway（HTTP）**：登录鉴权、大厅列表、资产/战绩查询、创建或加入桌。
2. **客户端 ↔ Realtime Gateway（WebSocket/RTC）**：长连接指令与桌状态广播，支持断线重连后的快照+增量同步。
3. **Realtime Gateway → 牌桌管理服务**：基于桌号/会话的路由、心跳转发、异常断线通知托管或弃牌。
4. **牌桌管理服务 ↔ 游戏逻辑与裁决服务**：驱动局面状态机、发牌、行动计时、边池与比牌、防作弊校验。
5. **牌桌管理服务 ↔ 数据/战绩服务（通过 MQ）**：事件入库、战绩更新、回放索引生成。
6. **牌桌管理服务 ↔ 经济服务**：虚拟积分买入、退还、结算分配与异常回滚。
7. **客户端/桌服务 ↔ 聊天服务**：聊天/表情指令经过实时网关过滤与频控后广播。
8. **防作弊与风控服务**：监听实时事件，提供风险分级、踢出/禁言/封桌等回调。
9. **监控与运维**：收集指标与日志，支持运维面板操作。

## 可扩展性要点
- 座位数（6/9 人桌）与盲注、最小买入等参数以配置驱动，便于扩展其他玩法。
- 桌实例隔离与一致性哈希路由保证水平扩展能力。
- 协议采用 Protobuf/JSON 契约优先，公共组件（日志、鉴权、序列化、频控）下沉为共享库。
- 支持状态快照与增量事件流，方便回放与故障恢复。
